#!/usr/bin/env python
import argparse
import logging
import os
from parcel import manifest, HTTPClient, UDTClient
from parcel.log import get_logger

logging.root.setLevel(logging.INFO)
log = get_logger('parcel_client')


def get_client(args, token):
    if args.mode == 'udt':
        return UDTClient(
            args.proxy_host, args.proxy_port,
            args.server.pop(0), token, args.n_processes, args.dir)
    elif args.mode == 'http':
        return HTTPClient(
            args.server.pop(0), token, args.n_processes, args.dir)
    raise RuntimeError('Unknown functionality.')


def main(args):
    # Set verbosty
    if args.verbose:
        logging.root.setLevel(logging.DEBUG)
    # Create client
    client = get_client(args, args.token)
    # Create file list and remove duplicates
    file_ids = set([f['id'] for f in args.manifest] + args.file_ids)
    # Download files
    client.download_files(file_ids)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    general_parser = argparse.ArgumentParser(add_help=False)
    subparsers = parser.add_subparsers(help='Download using UDT or HTTP',
                                       dest='mode')

    #############################################################
    #                     General options
    #############################################################

    general_parser.add_argument('-m', '--manifest',
                                type=manifest.argparse_type,
                                default=list(),
                                help='GDC Download manifest file.')
    general_parser.add_argument('-v', '--verbose', action='store_true',
                                help='verbose logging')
    general_parser.add_argument('-d', '--dir',
                                default=os.path.abspath(os.getcwd()),
                                help='Directory to download files to. '
                                'Defaults to current dir')
    general_parser.add_argument('-x', '--no-stats', action='store_true',
                                help='turn off statistics printing')
    general_parser.add_argument('-n', '--n-processes', type=int, default=4,
                                help='Number of udt client connections.')
    general_parser.add_argument('server', metavar='server', type=str, nargs=1,
                                help='The parcel server udt address server[:port]')
    general_parser.add_argument('file_ids', metavar='file_id', type=str,
                                nargs='*', help='uuids to download')

    token_args = general_parser.add_mutually_exclusive_group(required=False)
    token_args.add_argument('-t', '--token-file',
                            type=lambda x: argparse.FileType('r')(x).read(),
                            dest='token',
                            help='authentication token file')
    token_args.add_argument('-T', '--token', default='', type=str,
                            dest='token', help='authentication token')

    #############################################################
    #                       UDT options
    #############################################################

    udt = subparsers.add_parser('udt', help='Download files via UDT',
                                parents=[general_parser])
    udt.add_argument('-i', '--proxy-host', default='localhost', type=str,
                     dest='proxy_host',
                     help='The port to bind the local proxy to')
    udt.add_argument('-p', '--proxy-port', default='9000', type=str,
                     dest='proxy_port',
                     help='The port to bind the local proxy to')

    #############################################################
    #                      HTTP options
    #############################################################

    http = subparsers.add_parser('http', help='Download files via HTTP',
                                 parents=[general_parser])

    #############################################################
    #                       Start client
    #############################################################

    args = parser.parse_args()
    main(args)
